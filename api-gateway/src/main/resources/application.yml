server:
  port: 4004 # Gateway listens on port 4004

spring:
  cloud:
    gateway:
      server:
        webflux:
          routes:
            - id: auth-service-route
              uri: http://auth-service:4009
              predicates:
                        - Path=/auth/**
              filters:
                        - StripPrefix=1
                        - name: CircuitBreaker
                          args:
                           name: authCircuitBreaker
                           fallbackUri: forward:/fallback/auth
                        - name: RequestRateLimiter
                          args:
                                   redis-rate-limiter:
                                     replenishRate: 10
                                     burstCapacity: 20
                                   key-resolver: "#{@userKeyResolver}"

                    # Route for /api/patients/** to patient-service
            - id: patient-service-route
              uri: http://patient-service:4000
              predicates:
                        - Path=/api/patients/**
              filters:

                        - JwtFilter

                    # Route for /api/docs/patients to patient-service /v3/api-docs
            - id: api-docs-patient-route
              uri: http://patient-service:4000
              predicates:
                        - Path=/api-docs/patients
              filters:
                        - RewritePath=/api-docs/patients,/v3/api-docs

            - id: api-docs-auth-route
              uri: http://auth-service:4005
              predicates:
                        - Path=/api-docs/auth
              filters:
                        - RewritePath=/api-docs/auth,/v3/api-docs
#  redis:
#    host: redis
#    port: 6370
#    timeout: 2000


resilience4j:
  circuitbreaker:
    instances:
      authCircuitBreaker:
        register-health-indicator: true
        sliding-window-type: COUNT_BASED
        sliding-window-size: 10
        minimum-number-of-calls: 5
        permitted-number-of-calls-in-half-open-state: 3
        wait-duration-in-open-state: 30s
        failure-rate-threshold: 50
        event-consumer-buffer-size: 10
management:
  endpoints:
    web:
      exposure:
        include: health,info,circuitbreakers
  endpoint:
    health:
      show-details: always
    circuitbreakers:
      enabled: true